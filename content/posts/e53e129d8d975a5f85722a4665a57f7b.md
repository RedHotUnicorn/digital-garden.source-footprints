---
title: Процедурные складки на одежде для мультфильма на основе Geometry Nodes / Хабр
date: 2024-01-25
src_link: https://www.notion.so/Geometry-Nodes-df55b8b63b4444cb9ff703e5bf7d9e70
src_date: '2024-01-25 09:17:00'
gold_link: https://habr.com/ru/companies/ru_mts/articles/788648/
gold_link_hash: e53e129d8d975a5f85722a4665a57f7b
tags:
- '#host_habr_com'
---

Привет, Хабр! Я Михаил Солуянов, ведущий разработчик в [МТС Авто](https://mts-auto.com/) — занимаюсь генерацией синтетических изображений для обучения нейросетей. В рабочее время я Unity-разработчик, а в свободное — инди-аниматор мультфильмов. Сегодня расскажу о том, как сделать складки на одежде без симуляции ткани в Blender.

В 2020 году я сделал мультфильм «Мышиный Новый год» ([ru](https://www.youtube.com/watch?v=R9yW1b1hrSU), [en](https://www.youtube.com/watch?v=BFrKYnzZ8o0)), который [попал на фестиваль Giffoni-50](https://www.giffonifilmfestival.it/en/film-giffoni50/4882-mice-xmas.html) — один из самых крутых фестивалей, специализирующихся на детской анимации. В мультфильме у меня были герои — антропоморфные мыши в миниатюрных одеждах. И мне захотелось добавить им складки на одежде, которые правдоподобно реагировали бы на их движения. Расскажу о том, как использовал Tension Map и почему перешёл в итоге на Geometry Nodes. Поехали!

![](https://habrastorage.org/getpro/habr/upload_files/d2d/1d2/155/d2d1d2155ab5fd2aa64a28f250e3c324.jpg)Мышонок со складками на кофте
-----------------------------

В первую очередь я подумал о физической симуляции ткани. Но у этого способа есть несколько минусов:

1. **Ресурсоёмко и долго**. На просчёт физических симуляций в каждом кадре для всех героев нужно время. Как и на настройку, подбор параметров веса, силы трения, сопротивления к сгибу и прочих нюансов. Это не то, чем ты располагаешь, делая мультфильм фактически в одиночку. Иначе говоря, если вы не можете выделить отдельного человека из команды на эту задачу, ничего не получится.
2. К тому же физическая симуляция ещё и **плохо контролируется**. Я хотел получить то, что часто называют artistic control — возможность настроить именно так, как ты хочешь, а не как получилось. Чтобы складка шла именно так, как я хочу, а не иначе, а результат был похож на референс.

Это подводит нас к другому вопросу: складки в основном не гуляют по одежде (кроме, разве что, очень объёмной одежды, длинных юбок и платьев). У ткани есть «эффект памяти»: она запоминает, каким образом согнулась, и в следующий раз загнётся так же, пока её не разгладишь утюгом. Некоторые складки образуются на участках сгибов, другие — при растяжении, натяжении ткани. И как их имитировать?

![](https://habrastorage.org/getpro/habr/upload_files/150/a29/699/150a29699e70a1694a735694cf521372.png "Складки сгиба")

*Складки сгиба*

![](https://habrastorage.org/getpro/habr/upload_files/b9f/467/f7d/b9f467f7d4779e8dc5b51ef4cbfb5043.png "Складки растяжения ")

*Складки растяжения* 

В графике давно используется **способ компенсации формы** путём добавления корректирующих ключей формы (**Corrective Shape Keys**). 

Работает это так: мы создаём дополнительные ключи формы (**Shape keys/Blend Shapes)**. Они определяют форму объекта с возможностью [интерполяции](https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BF%D0%BE%D0%BB%D1%8F%D1%86%D0%B8%D1%8F#:~:text=%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BF%D0%BE%D0%BB%D1%8F%CC%81%D1%86%D0%B8%D1%8F%2C%20%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D0%BF%D0%BE%D0%BB%D0%B8%CC%81%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20(%D0%BE%D1%82%20%D0%BB%D0%B0%D1%82.,%D0%B5%D1%91%20%D0%B8%D0%B7%D0%B2%D0%B5%D1%81%D1%82%D0%BD%D1%8B%D1%85%20%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B9%2C%20%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%20%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D0%BE%D0%BC.) между разными состояниями. 

Далее двигаем форму модели как нам нужно, например, образуя складки отдельно для каждого сустава. Затем мы ставим зависимость каждого ключа формы от положения, поворота определённых костей. Согнули руку в локте — соответствующий ключ формы со складками на руке стал более видимым.

![](https://habrastorage.org/getpro/habr/upload_files/c4d/712/aab/c4d712aabcf85b4f6baea181c25b5556.png "Работа корректирующих ключей формы для имитации сокращения мышц и улучшения сгиба в районе локтя (картинка из интернета)")

*Работа корректирующих ключей формы для имитации сокращения мышц и улучшения сгиба в районе локтя (картинка из интернета)*

Этот метод хоть и даёт полный artistic control, но требует много времени и труда. Да, можно сделать это для одного персонажа, но для нескольких? Большой команде этот метод подойдёт, а для персонального проекта я искал более простое и быстрое решение.

Поиск простого решения для аниматоров-одиночек
----------------------------------------------

Это привело меня к аддону Tension map. [Есть небольшое видео](https://www.youtube.com/watch?v=QfbXeP8LgEg), объясняющее принцип его работы.

Суть такова: при деформации объекта изменяются размеры его составных частей — рёбер, полигонов. Скрипт сохраняет размеры до и после деформации, сравнивает изменения в размере. Далее мы берём эти данные и используем для визуализации складок. Чем сильнее уменьшается размер, тем заметнее складка. Но самое главное — мы можем нарисовать складки для всей модели целиком, а не для каждого участка отдельно. Используя данные от аддона, мы из целой карты складок активируем только те участки, которые нам нужны.

Теперь о самой «карте складок». Есть несколько способов имитации неровности поверхности:

1. **Карта нормалей.** Этот способ не меняет геометрию объекта, а лишь имитирует неровности. Эффект пропадает, если неровности слишком большие или должны влиять на контур объекта. Поэтому его можно использовать для небольших складок типа морщин на лице, но не для одежды, тем более такой миниатюрной, как у моих персонажей.

![](https://habrastorage.org/getpro/habr/upload_files/8ac/be8/47d/8acbe847d3809300b8add3938c14665a.png "Имитация неровности поверхности с помощью карты нормалей на одном из моих проектов")

*Имитация неровности поверхности с помощью карты нормалей на одном из моих проектов*

1. **Карта высот.** На уровне модификатора или шейдера поверхность геометрии отклоняется, формируя настоящие складки. Для этого способа нужна более детализированная модель, ведь чем больше точек, тем детальнее складки.

![](https://habrastorage.org/getpro/habr/upload_files/1d4/c79/aa0/1d4c79aa0396a580c5b8d7032fe78fe0.png "Видимость карты высот с различным уровнем детализации поверхности")

*Видимость карты высот с различным уровнем детализации поверхности*

![](https://habrastorage.org/getpro/habr/upload_files/b0d/4fe/6fc/b0d4fe6fc27282b10497d30615ee2997.png "Пример карты высот для складок")

*Пример карты высот для складок*

Итак, я стал делать складки с помощью карты высот. И, казалось бы, решение найдено. Но до финального рендера дело так и не дошло. 

Всё сложнее, чем кажется
------------------------

Почему? На то есть несколько причин:

1. **Tension map — это аддон, написанный на Python.** И если персонаж подключён в сцену из внешнего файла, а не скопирован напрямую, то код аддона просто отказывался работать в этой сцене. 

Но почему нельзя просто копировать персонажа из сцены в сцену? В процессе создания мультфильма персонаж может дорабатываться. Нужно, чтобы изменения были учтены во всех сценах, где этот персонаж используется. Поэтому он подключён из одного внешнего файла как библиотека, а все изменения, связанные с ним, отображаются во всех сценах.
2. [**Рендер-фермы**](https://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%BD%D0%B4%D0%B5%D1%80-%D1%84%D0%B5%D1%80%D0%BC%D0%B0) **не любят аддоны.** Если анимация зависит от включённых аддонов, то не все рендер-фермы позволят вам установить и включить нужный аддон. А я рендерил именно на ферме, поскольку своих вычислительных мощностей не хватало.
3. Ещё один минус — **нужно «запечь», зафиксировать первоначальный размер полигонов**. Если в персонажа вносятся какие-либо правки на уровне полигонов, нужно не забыть заново «запечь» данные для Tension map.

В результате аддон я так и не задействовал, просто сделал складки видимыми всегда. Это выглядело не сильно плохо, на мешковатых фигурках смотрелось приемлемо.

Как релиз Geometry Nodes вернул к идее со складками
---------------------------------------------------

Но вот с появлением Geometry Nodes я вернулся к мысли сделать складки в своём следующем мультфильме. Вместо медленного и неудобного в использовании аддона у нас появился модификатор Geometry Nodes, который:

* **быстрый**, т. к. не использует Python
* **работает во внешней сцене**, т. к. оформлен в виде модификатора. Модификаторы не подключаются извне, они — часть программы, поэтому **работают быстрее и надёжнее**

Деформация геометрии по текстуре с помощью GN тоже не вызывала проблем, тут всё понятно. Осталось решить только один вопрос — как получить карту натяжения

Как получить карту натяжения
----------------------------

Есть несколько вариантов, сейчас расскажу о них.

Первый способ — использование копии модели без деформации, как это предлагают [Blender Studio](https://studio.blender.org/blog/procedural-wrinkles/). То есть мы храним где-то в скрытом виде копию объекта и сравниваем размеры рёбер с деформированной геометрией. 

Попадался мне и другой способ: в его основе карта «запекалась» в текстуру, из которой в дальнейшем брались данные. 

Оба варианта не особо удобны — надо что-то «запекать» или держать на скрытом слое. Мне же хотелось, чтобы всё было легко — включил и забыл.

Я обратил внимание на атрибут [Rest position](https://docs.blender.org/manual/en/latest/animation/shape_keys/shape_keys_panel.html#bpy-types-object-add-rest-position-attribute), который ввели для новой системы анимации волос на Geometry Nodes. Он содержит положение недеформированных точек и используется для перемещения волос нодой Deform curves on surface. Она позволяет волосам «не отлипать» при анимации, так как берёт положение [вершин меша](https://docs.unity3d.com/ru/2019.4/Manual/AnatomyofaMesh.html) до деформации из этого атрибута и перемещает волосы к деформированному мешу.

![](https://habrastorage.org/getpro/habr/upload_files/ccb/a91/f3d/ccba91f3dbe2eb6043c79d5d52187a8b.png "Складки сгиба и растяжения на руке")

*Складки сгиба и растяжения на руке*

Используя этот атрибут, мы можем определить, где сетка модели становится плотнее, а где она более разрежена. В этом помогает модификатор Geometry Nodes:

![](https://habrastorage.org/getpro/habr/upload_files/0c8/ddb/1b4/0c8ddb1b4692f6108aead4a13376f807.png "Сетап (node tree) расчёта сжатия/растяжения")

*Сетап (node tree) расчёта сжатия/растяжения*

1. GN определяет расстояние между точками: текущее и первоначальное, записанное в атрибуте Rest Position. Так мы получаем разницу в длинах рёбер.
2. Затем записываем эту разницу в вершины меша, используя ноду [Evaluate on domain](https://docs.blender.org/manual/ru/dev/modeling/geometry_nodes/utilities/field/evaluate_on_domain.html).
3. Результат сохраняем в новый атрибут (я его назвал FaceArea), который будет отвечать за размер складок. На скриншоте ниже можно посмотреть результат вычислений: синим обозначены зоны, где меш сжат, красным — где растянут.

![](https://habrastorage.org/getpro/habr/upload_files/45a/776/4ca/45a7764caa5ccf2daf54d008b92b129d.png "Синий — зоны сжатия, красный — зоны расширения")

*Синий — зоны сжатия, красный — зоны расширения*

Я не деформирую точки сразу по двум причинам: **во-первых, я стараюсь ограничивать группу нодов по функциональности**, чтобы он не перерастал в огромную кашу, в которой будет сложно потом разобраться. **Вторая причина** **—** **я использую стандартный модификатор subdivision subsurf**, который разбивает меш на мелкие элементы и делает его более детальным. 

На следующем скрине — сетап (node tree) для добавления складок на поверхность модели. Я использую ранее сохранённый атрибут FaceArea и специально созданный атрибут Folds, которым я могу дополнительно контролировать степень видимости складок. Полученное значение перемещает вершины меша в зависимости от нарисованной текстуры складок.

![](https://habrastorage.org/getpro/habr/upload_files/5d5/a06/ec2/5d5a06ec2b78023da90a3d780076d68b.png "Сетап добавления складок на подразделённую поверхность   ")

*Сетап добавления складок на подразделённую поверхность* 

![](https://habrastorage.org/getpro/habr/upload_files/0b6/50a/8ae/0b650a8ae054c57dcb411d609d8f4088.png "Без складок")

*Без складок*

![](https://habrastorage.org/getpro/habr/upload_files/ff6/186/184/ff61861843d3541e676a0feaf15a1f19.png "Со складками")

*Со складками*

Стоит заметить, не мне первому пришла в голову идея использовать ноды для создания такого типа складок. Вот, например, [статья Blender Studio о создании морщин описанным способом](https://studio.blender.org/blog/procedural-wrinkles/). 

Мне морщины не нужны, поскольку мои герои покрыты мехом и перьями. Поэтому в сетапе есть некоторые отличия:

1. **Направление сжатия**. Это важно для морщин, например, на лбу. Я им пренебрёг. Потому как в принципе на одежде это не наблюдается.
2. **Используется копия объекта** вместо атрибута Rest Position. Возможно, чтобы получить данные по рёбрам или просто более детальную карту после подразделения. Вероятно, потому, что этот сетап делался до создания атрибута Rest Position — точно сказать не могу.

Хорош ли этот сетап? Мне кажется, для моих целей его достаточно. Да, конечно, он не подойдёт для имитации лёгкой одежды и юбок, но, как и другие методы, его нужно применять там, где он уместен. 

Готов ответить на вопросы в комментариях, а также жду вас в [моём сообществе](https://vk.com/blender_3d)! 

![](https://habrastorage.org/getpro/habr/upload_files/c25/23b/ea7/c2523bea7a58bfb4a9f899bdcd7b10ae.png)